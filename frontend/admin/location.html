<div class="container-fluid">
  <h4 class="mb-3">Location Management</h4>

  <form id="locationForm" class="mb-4" novalidate>
    <div class="form-group mb-2">
      <label>Location Name</label>
      <input
        type="text"
        id="location_name"
        class="form-control"
        placeholder="Enter Location Name"
        required
      />
    </div>

    <div class="form-group mb-2">
      <label>Location Details</label>
      <input
        type="text"
        id="location_details"
        class="form-control"
        placeholder="Enter Location Details"
      />
    </div>

    <div class="form-group mb-2">
      <label>Google Map URL</label>
      <input
        type="text"
        id="map"
        class="form-control"
        placeholder="Enter Map URL"
      />
    </div>

    <button type="button" id="submitBtn" class="btn btn-success">
      Add Location
    </button>
  </form>

  <table class="table table-bordered table-striped text-center align-middle">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Location Name</th>
        <th>Details</th>
        <th>Map</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="locationTable"></tbody>
  </table>
</div>

<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
  function initLocationPage() {
    const API_URL = "http://localhost:5000/locations"; // Backend route
    let editId = null;

    const tableBody = document.getElementById("locationTable");
    const submitBtn = document.getElementById("submitBtn");

    // Load All Locations
    async function loadLocations() {
      try {
        const res = await fetch(API_URL);
        const result = await res.json();
        renderTable(result.data);
      } catch (err) {
        console.error("Error:", err);
        toastr.error("Failed to load locations.");
      }
    }

    // Render Table
    function renderTable(locations) {
      tableBody.innerHTML = "";
      if (!locations || !locations.length) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-muted">No locations found.</td></tr>`;
        return;
      }

      locations.forEach((loc) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${loc.id}</td>
          <td>${loc.location_name}</td>
          <td>${loc.location_details || "-"}</td>
          <td><a href="${loc.map || "#"}" target="_blank">${
          loc.map || "-"
        }</a></td>
          <td>
            <button class="btn btn-warning btn-sm editBtn">Edit</button>
            <button class="btn btn-danger btn-sm deleteBtn">Delete</button>
          </td>
        `;

        // Edit
        row.querySelector(".editBtn").addEventListener("click", () => {
          document.getElementById("location_name").value = loc.location_name;
          document.getElementById("location_details").value =
            loc.location_details || "";
          document.getElementById("map").value = loc.map || "";

          editId = loc.id;
          submitBtn.textContent = "Update Location";
        });

        // Delete
        row.querySelector(".deleteBtn").addEventListener("click", async () => {
          if (!confirm("Are you sure you want to delete this location?"))
            return;

          try {
            const res = await fetch(`${API_URL}/${loc.id}`, {
              method: "DELETE",
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);

            toastr.success(data.message);
            loadLocations();
          } catch (err) {
            console.error(err);
            toastr.error("Error deleting location");
          }
        });

        tableBody.appendChild(row);
      });
    }

    // Submit Button
    submitBtn.addEventListener("click", async () => {
      const form = document.getElementById("locationForm");

      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const payload = {
        location_name: document.getElementById("location_name").value,
        location_details: document.getElementById("location_details").value,
        map: document.getElementById("map").value,
      };

      try {
        const method = editId ? "PUT" : "POST";
        const url = editId ? `${API_URL}/${editId}` : API_URL;

        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        if (!data.success) throw new Error(data.message);

        toastr.success(data.message);
        form.reset();
        editId = null;
        submitBtn.textContent = "Add Location";
        loadLocations();
      } catch (err) {
        console.error(err);
        toastr.error("Error saving location");
      }
    });

    loadLocations();
  }

  initLocationPage();
</script>
