<div class="container-fluid">
  <h4 class="mb-3">Testimonials Management</h4>

  <form
    id="testimonialForm"
    class="mb-4"
    enctype="multipart/form-data"
    novalidate
  >
    <div class="form-group mb-2">
      <label>Client Name</label>
      <input
        type="text"
        id="client_name"
        class="form-control"
        placeholder="Enter Client Name"
        required
      />
    </div>

    <div class="form-group mb-2">
      <label>Profession</label>
      <input
        type="text"
        id="profession"
        class="form-control"
        placeholder="Enter Profession"
      />
    </div>

    <div class="form-group mb-2">
      <label>Testimonial Details</label>
      <textarea
        id="details"
        class="form-control"
        placeholder="Enter Testimonial Details"
        maxlength="350"
      ></textarea>
    </div>

    <div class="form-group mb-2">
      <label>Client Image</label>
      <input type="file" id="image" class="form-control" accept="image/*" />
    </div>

    <button type="button" id="submitBtn" class="btn btn-success">
      Add Testimonial
    </button>
  </form>

  <table class="table table-bordered table-striped text-center align-middle">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Client Name</th>
        <th>Profession</th>
        <th>Details</th>
        <th>Image</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="testimonialTable"></tbody>
  </table>
</div>

<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
  function initTestimonialsPage() {
    const API_URL = "http://localhost:5000/testimonials";
    let editId = null;

    const tableBody = document.getElementById("testimonialTable");
    const submitBtn = document.getElementById("submitBtn");

    async function loadTestimonials() {
      try {
        const res = await fetch(API_URL);
        const result = await res.json();
        renderTable(result.data);
      } catch (err) {
        console.error("Error loading testimonials:", err);
        toastr.error("Failed to load testimonials.");
      }
    }

    function renderTable(testimonials) {
      tableBody.innerHTML = "";
      if (!testimonials || !testimonials.length) {
        tableBody.innerHTML = `<tr><td colspan="6" class="text-muted">No testimonials found.</td></tr>`;
        return;
      }

      testimonials.forEach((testimonial) => {
        const img = testimonial.image
          ? `<img src="http://localhost:5000${testimonial.image}" width="60" height="60" style="object-fit:cover;border-radius:8px;"/>`
          : "-";

        const row = document.createElement("tr");
        row.innerHTML = `
        <td>${testimonial.id}</td>
        <td>${testimonial.client_name}</td>
        <td>${testimonial.profession || "-"}</td>
        <td>${testimonial.details || "-"}</td>
        <td>${img}</td>
        <td>
          <button class="btn btn-warning btn-sm editBtn">Edit</button>
          <button class="btn btn-danger btn-sm deleteBtn">Delete</button>
        </td>
      `;

        row.querySelector(".editBtn").addEventListener("click", () => {
          document.getElementById("client_name").value =
            testimonial.client_name;
          document.getElementById("profession").value =
            testimonial.profession || "";
          document.getElementById("details").value = testimonial.details || "";
          editId = testimonial.id;
          submitBtn.textContent = "Update Testimonial";
        });

        row.querySelector(".deleteBtn").addEventListener("click", async () => {
          if (!confirm("Are you sure you want to delete this testimonial?"))
            return;
          try {
            const res = await fetch(`${API_URL}/${testimonial.id}`, {
              method: "DELETE",
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            toastr.success(data.message);
            loadTestimonials();
          } catch (err) {
            toastr.error(err.message);
          }
        });

        tableBody.appendChild(row);
      });
    }

    submitBtn.addEventListener("click", async () => {
      const form = document.getElementById("testimonialForm");
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const formData = new FormData();
      formData.append(
        "client_name",
        document.getElementById("client_name").value
      );
      formData.append(
        "profession",
        document.getElementById("profession").value
      );
      formData.append("details", document.getElementById("details").value);
      const file = document.getElementById("image").files[0];
      if (file) formData.append("image", file);

      try {
        const method = editId ? "PUT" : "POST";
        const url = editId ? `${API_URL}/${editId}` : API_URL;
        const res = await fetch(url, { method, body: formData });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);

        toastr.success(data.message);
        editId = null;
        submitBtn.textContent = "Add Testimonial";
        form.reset();
        loadTestimonials();
      } catch (err) {
        toastr.error(err.message);
      }
    });

    loadTestimonials();
  }

  initTestimonialsPage();
</script>
