<div class="container-fluid">
  <h4 class="mb-3">Property Management</h4>

  <form id="propertyForm" class="mb-4" novalidate>
    <div class="row">
      <div class="col-md-4 mb-2">
        <label>Property Title</label>
        <input type="text" id="property_title" class="form-control" required />
      </div>

      <div class="col-md-4 mb-2">
        <label>Price</label>
        <input type="text" id="price" class="form-control" required />
      </div>

      <div class="col-md-4 mb-2">
        <label>Category</label>
        <select id="category" class="form-control" required></select>
      </div>

      <div class="col-md-4 mb-2">
        <label>Feature Category</label>
        <select id="feture_category" class="form-control" required></select>
      </div>

      <div class="col-md-6 mb-2">
        <label>Short Description</label>
        <textarea
          id="short_description"
          class="form-control"
          required
        ></textarea>
      </div>

      <div class="col-md-4 mb-2">
        <label>Location</label>
        <select id="location" class="form-control" required></select>
      </div>

      <div class="col-md-6 mb-2">
        <label>Property Description</label>
        <textarea
          id="property_description"
          class="form-control"
          required
        ></textarea>
      </div>

      <div class="col-md-4 mb-2">
        <label>Size</label>
        <input type="text" id="size" class="form-control" />
      </div>

      <div class="col-md-4 mb-2">
        <label>Bedrooms</label>
        <input type="text" id="bedrooms" class="form-control" />
      </div>

      <div class="col-md-4 mb-2">
        <label>Bathrooms</label>
        <input type="text" id="bathrooms" class="form-control" />
      </div>

      <div class="col-md-4 mb-2">
        <label>Kitchen</label>
        <input type="text" id="kitchen" class="form-control" />
      </div>

      <div class="col-md-4 mb-2">
        <label>Year Built</label>
        <input type="text" id="year_built" class="form-control" />
      </div>
    </div>

    <hr />

    <!-- CHECKBOXES -->
    <div class="row">
      <div class="col-md-3">
        <input type="checkbox" id="garage" checked /> Garage
      </div>
      <div class="col-md-3"><input type="checkbox" id="heating" /> Heating</div>
      <div class="col-md-3">
        <input type="checkbox" id="air_conditioning" /> AC
      </div>
      <div class="col-md-3">
        <input type="checkbox" id="wifi" checked /> Wifi
      </div>

      <div class="col-md-3 mt-2">
        <input type="checkbox" id="security_cameras" checked /> Security Cameras
      </div>
      <div class="col-md-3 mt-2">
        <input type="checkbox" id="cable_tv" checked /> Cable TV
      </div>
      <div class="col-md-3 mt-2">
        <input type="checkbox" id="solar_power" /> Solar Power
      </div>
      <div class="col-md-3 mt-2">
        <input type="checkbox" id="fireplace" checked /> Fireplace
      </div>

      <div class="col-md-3 mt-2">
        <input type="checkbox" id="ventilation" checked /> Ventilation
      </div>
      <div class="col-md-3 mt-2">
        <input type="checkbox" id="internet" checked /> Internet
      </div>
      <div class="col-md-3 mt-2">
        <input type="checkbox" id="lift" checked /> Lift
      </div>
      <div class="col-md-3 mt-2">
        <input type="checkbox" id="dishwasher" /> Dishwasher
      </div>

      <div class="col-md-3 mt-2"><input type="checkbox" id="pool" /> Pool</div>
      <div class="col-md-3 mt-2">
        <input type="checkbox" id="parking" checked /> Parking
      </div>
      <div class="col-md-3 mt-2"><input type="checkbox" id="gym" /> Gym</div>
    </div>

    <button type="button" id="submitBtn" class="btn btn-success mt-3">
      Add Property
    </button>
  </form>

  <table class="table table-bordered table-striped text-center align-middle">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Category</th>
        <th>Feature Category</th>
        <th>Price</th>
        <th>Location</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="propertyTable"></tbody>
  </table>
</div>

<script>
  const API_URL = "http://localhost:5000/properties";
  let editId = null;

  async function loadDropdown(url, elementId, valueKey, textKey, placeholder) {
    try {
      const res = await fetch(url);
      const data = await res.json();
      const dropdown = document.getElementById(elementId);
      dropdown.innerHTML = `<option value="">${placeholder}</option>`;
      data.data.forEach((item) => {
        dropdown.innerHTML += `<option value="${item[valueKey]}">${item[textKey]}</option>`;
      });
    } catch (err) {
      console.error("Dropdown Load Error:", err);
    }
  }

  function gatherFormData() {
    const fields = [
      "property_title",
      "price",
      "category",
      "feture_category",
      "location",
      "short_description",
      "property_description",
      "size",
      "bedrooms",
      "bathrooms",
      "kitchen",
      "year_built",
    ];

    const formData = new FormData();

    fields.forEach((id) => {
      const field = document.getElementById(id);
      if (!field) return;

      let value = field.value;
      if (["category", "feture_category", "location"].includes(id)) {
        value = value ? parseInt(value) : null;
      }
      formData.append(id, value);
    });

    const checks = [
      "garage",
      "heating",
      "air_conditioning",
      "wifi",
      "security_cameras",
      "cable_tv",
      "solar_power",
      "fireplace",
      "ventilation",
      "internet",
      "lift",
      "dishwasher",
      "pool",
      "parking",
      "gym",
    ];

    checks.forEach((id) => {
      const check = document.getElementById(id);
      if (check) formData.append(id, check.checked ? 1 : 0);
    });

    return formData;
  }

  async function loadProperties() {
    try {
      const res = await fetch(API_URL);
      const data = await res.json();
      renderTable(data.data);
    } catch (err) {
      console.error("Load properties error:", err);
    }
  }

  function renderTable(properties) {
    const tableBody = document.getElementById("propertyTable");
    tableBody.innerHTML = "";

    if (!properties.length) {
      tableBody.innerHTML = `<tr><td colspan="7">No property found</td></tr>`;
      return;
    }

    properties.forEach((p) => {
      const row = `
      <tr>
        <td>${p.id}</td>
        <td>${p.property_title}</td>
        <td>${p.category_name}</td>
        <td>${p.feture_category}</td>
        <td>${p.price}</td>
        <td>${p.location_name}</td>
        <td>
          <button class="btn btn-warning btn-sm editBtn" data-id="${p.id}">Edit</button>
          <button class="btn btn-danger btn-sm deleteBtn" data-id="${p.id}">Delete</button>
        </td>
      </tr>`;
      tableBody.innerHTML += row;
    });

    document
      .querySelectorAll(".editBtn")
      .forEach((btn) =>
        btn.addEventListener("click", () => editProperty(btn.dataset.id))
      );
    document
      .querySelectorAll(".deleteBtn")
      .forEach((btn) =>
        btn.addEventListener("click", () => deleteProperty(btn.dataset.id))
      );
  }

  async function editProperty(id) {
    try {
      const res = await fetch(`${API_URL}/${id}`);
      const p = (await res.json()).data;
      editId = id;

      Object.keys(p).forEach((key) => {
        const el = document.getElementById(key);
        if (!el) return;

        if (el.type === "checkbox") el.checked = p[key] == 1;
        else el.value = p[key] ?? "";
      });
    } catch (err) {
      console.error("Edit error:", err);
    }
  }

  async function deleteProperty(id) {
    if (!confirm("Are you sure to delete?")) return;
    try {
      await fetch(`${API_URL}/${id}`, { method: "DELETE" });
      loadProperties();
    } catch (err) {
      console.error("Delete error:", err);
    }
  }

  document.getElementById("submitBtn").addEventListener("click", async () => {
    const formData = gatherFormData();

    const jsonData = {};
    formData.forEach((value, key) => (jsonData[key] = value));

    try {
      const res = await fetch(editId ? `${API_URL}/${editId}` : API_URL, {
        method: editId ? "PUT" : "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(jsonData),
      });

      const data = await res.json();
      if (!data.success) throw new Error(data.message);

      alert(data.message);
      document.getElementById("propertyForm").reset();
      editId = null;
      loadProperties();
    } catch (err) {
      console.error("Save property error:", err);
      alert("Error saving property: " + err.message);
    }
  });

  // Load dropdowns and table
  loadDropdown(
    "http://localhost:5000/properties/categories",
    "category",
    "id",
    "category_name",
    "Select Category"
  );
  loadDropdown(
    "http://localhost:5000/properties/feature-categories",
    "feture_category",
    "id",
    "category_name",
    "Select Feature"
  );
  loadDropdown(
    "http://localhost:5000/properties/locations",
    "location",
    "id",
    "location_name",
    "Select Location"
  );
  loadProperties();
</script>
