<div class="container-fluid">
  <h4 class="mb-3">Agents Management</h4>

  <form id="agentForm" class="mb-4" enctype="multipart/form-data" novalidate>
    <div class="form-group mb-2">
      <label>Agent Name</label>
      <input
        type="text"
        id="name"
        class="form-control"
        placeholder="Enter Agent Name"
        required
      />
    </div>

    <div class="form-group mb-2">
      <label>Designation</label>
      <input
        type="text"
        id="designation"
        class="form-control"
        placeholder="Enter Designation"
      />
    </div>

    <div class="form-group mb-2">
      <label>Facebook URL</label>
      <input
        type="text"
        id="facebook"
        class="form-control"
        placeholder="Enter Facebook URL"
      />
    </div>

    <div class="form-group mb-2">
      <label>Twitter URL</label>
      <input
        type="text"
        id="twitter"
        class="form-control"
        placeholder="Enter Twitter URL"
      />
    </div>

    <div class="form-group mb-2">
      <label>Instagram URL</label>
      <input
        type="text"
        id="instagram"
        class="form-control"
        placeholder="Enter Instagram URL"
      />
    </div>

    <div class="form-group mb-2">
      <label>Agent Image</label>
      <input type="file" id="image" class="form-control" accept="image/*" />
    </div>

    <button type="button" id="submitBtn" class="btn btn-success">
      Add Agent
    </button>
  </form>

  <table class="table table-bordered table-striped text-center align-middle">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Designation</th>
        <th>Facebook</th>
        <th>Twitter</th>
        <th>Instagram</th>
        <th>Image</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="agentTable"></tbody>
  </table>
</div>

<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
  function initAgentPage() {
    const API_URL = "http://localhost:5000/agents";
    let editId = null;

    const tableBody = document.getElementById("agentTable");
    const submitBtn = document.getElementById("submitBtn");

    async function loadAgents() {
      try {
        const res = await fetch(API_URL);
        const result = await res.json();
        renderTable(result.data);
      } catch (err) {
        toastr.error("Failed to load agents.");
        console.error(err);
      }
    }

    function renderTable(agents) {
      tableBody.innerHTML = "";
      if (!agents || !agents.length) {
        tableBody.innerHTML = `<tr><td colspan="8" class="text-muted">No agents found.</td></tr>`;
        return;
      }

      agents.forEach((agent) => {
        const img = agent.image
          ? `<img src="http://localhost:5000${agent.image}" width="60" height="60" style="object-fit:cover;border-radius:8px;"/>`
          : "-";

        const row = document.createElement("tr");
        row.innerHTML = `
        <td>${agent.id}</td>
        <td>${agent.name}</td>
        <td>${agent.designation || "-"}</td>
        <td><a href="${agent.facebook || "#"}" target="_blank">${
          agent.facebook || "-"
        }</a></td>
        <td><a href="${agent.twitter || "#"}" target="_blank">${
          agent.twitter || "-"
        }</a></td>
        <td><a href="${agent.instagram || "#"}" target="_blank">${
          agent.instagram || "-"
        }</a></td>
        <td>${img}</td>
        <td>
          <button class="btn btn-warning btn-sm editBtn">Edit</button>
          <button class="btn btn-danger btn-sm deleteBtn">Delete</button>
        </td>
      `;

        row.querySelector(".editBtn").addEventListener("click", () => {
          document.getElementById("name").value = agent.name;
          document.getElementById("designation").value =
            agent.designation || "";
          document.getElementById("facebook").value = agent.facebook || "";
          document.getElementById("twitter").value = agent.twitter || "";
          document.getElementById("instagram").value = agent.instagram || "";
          editId = agent.id;
          submitBtn.textContent = "Update Agent";
        });

        row.querySelector(".deleteBtn").addEventListener("click", async () => {
          if (!confirm("Are you sure?")) return;
          try {
            const res = await fetch(`${API_URL}/${agent.id}`, {
              method: "DELETE",
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            toastr.success(data.message);
            loadAgents();
          } catch (err) {
            toastr.error(err.message);
          }
        });

        tableBody.appendChild(row);
      });
    }

    submitBtn.addEventListener("click", async () => {
      const form = document.getElementById("agentForm");
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const formData = new FormData();
      formData.append("name", document.getElementById("name").value);
      formData.append(
        "designation",
        document.getElementById("designation").value
      );
      formData.append("facebook", document.getElementById("facebook").value);
      formData.append("twitter", document.getElementById("twitter").value);
      formData.append("instagram", document.getElementById("instagram").value);
      const file = document.getElementById("image").files[0];
      if (file) formData.append("image", file);

      try {
        const method = editId ? "PUT" : "POST";
        const url = editId ? `${API_URL}/${editId}` : API_URL;
        const res = await fetch(url, { method, body: formData });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);

        toastr.success(data.message);
        editId = null;
        submitBtn.textContent = "Add Agent";
        form.reset();
        loadAgents();
      } catch (err) {
        toastr.error(err.message);
      }
    });

    loadAgents();
  }

  initAgentPage();
</script>
