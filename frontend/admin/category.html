<div class="container-fluid">
  <h4 class="mb-3">Category Management</h4>

  <form id="categoryForm" class="mb-4" enctype="multipart/form-data" novalidate>
    <div class="form-group mb-2">
      <label>Category Name</label>
      <input
        type="text"
        id="category_name"
        class="form-control"
        placeholder="Category Name"
        required
      />
    </div>

    <div class="form-group mb-2">
      <label>Slug</label>
      <input
        type="text"
        id="slug"
        class="form-control"
        placeholder="Slug"
        required
      />
    </div>

    <div class="form-group mb-2">
      <label>Category Image</label>
      <input type="file" id="icon" class="form-control" accept="image/*" />
    </div>

    <button type="button" id="submitBtn" class="btn btn-success">
      Add Category
    </button>
  </form>

  <table class="table table-bordered table-striped text-center">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Slug</th>
        <th>Image</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="categoryTable"></tbody>
  </table>
</div>

<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
  function initCategoryPage() {
    const API_URL = "http://localhost:5000/category";
    let editId = null;
    let categories = [];

    const tableBody = document.getElementById("categoryTable");
    const submitBtn = document.getElementById("submitBtn");

    // Load all categories
    async function loadCategories() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        categories = data;
        renderTable(data);
      } catch (err) {
        console.error("Error loading categories:", err);
        toastr.error("Failed to load categories.");
      }
    }

    // Render table
    function renderTable(data) {
      tableBody.innerHTML = "";
      if (!data.length) {
        tableBody.innerHTML =
          "<tr><td colspan='5' class='text-muted'>No categories found.</td></tr>";
        return;
      }

      data.forEach((cat) => {
        const imageCell = cat.image
          ? `<img src="http://localhost:5000${cat.image}" width="60" height="60" style="object-fit:cover;border-radius:8px;"/>`
          : "-";

        const row = document.createElement("tr");
        row.innerHTML = `
        <td>${cat.id}</td>
        <td>${cat.name}</td>
        <td>${cat.slug}</td>
        <td>${imageCell}</td>
        <td>
          <button class="btn btn-warning btn-sm editBtn"><i class="fas fa-edit"></i></button>
          <button class="btn btn-danger btn-sm deleteBtn"><i class="fas fa-trash"></i></button>
        </td>
      `;

        // Edit button
        row.querySelector(".editBtn").addEventListener("click", () => {
          document.getElementById("category_name").value = cat.name;
          document.getElementById("slug").value = cat.slug;
          editId = cat.id;
          submitBtn.textContent = "Update Category";
        });

        // Delete button
        row.querySelector(".deleteBtn").addEventListener("click", async () => {
          if (!confirm("Are you sure you want to delete this category?"))
            return;
          try {
            const res = await fetch(`${API_URL}/${cat.id}`, {
              method: "DELETE",
            });
            const data = await res.json();
            if (!data.success)
              throw new Error(data.message || "Error deleting category");
            toastr.success(data.message);
            loadCategories();
          } catch (err) {
            console.error("Delete error:", err);
            toastr.error(err.message || "Error deleting category");
          }
        });

        tableBody.appendChild(row);
      });
    }

    // Add or Update Category
    submitBtn.addEventListener("click", async () => {
      const form = document.getElementById("categoryForm");
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const formData = new FormData();
      formData.append(
        "category_name",
        document.getElementById("category_name").value
      );
      formData.append("slug", document.getElementById("slug").value);
      const file = document.getElementById("icon").files[0];
      if (file) formData.append("icon", file);

      try {
        const method = editId ? "PUT" : "POST";
        const url = editId ? `${API_URL}/${editId}` : API_URL;
        const res = await fetch(url, { method, body: formData });
        const data = await res.json();
        if (!data.success)
          throw new Error(data.message || "Error saving category");

        toastr.success(data.message);
        editId = null;
        submitBtn.textContent = "Add Category";
        form.reset();
        loadCategories();
      } catch (err) {
        console.error("Error saving category:", err);
        toastr.error(err.message || "Error saving category");
      }
    });

    loadCategories();
  }

  // Call initCategoryPage whenever you inject category HTML
  initCategoryPage();
</script>
